---
import { Image } from 'astro:assets'
import type { CollectionEntry } from 'astro:content'
import { getCollection } from 'astro:content'
import { formatTitle, dateFormatter } from '../utils/formatting'

interface Props {
  id: string
}

const { id } = Astro.props

const allBlogs = await getCollection('blog')
const blog = allBlogs.find(
  (blog: CollectionEntry<'blog'>) => blog.data.id === id,
)
if (!blog) {
  throw new Error(`Could not find blog entry with id: ${id}`)
}

const formattedTitle = formatTitle(blog!.data.title)

const formattedDate = dateFormatter.format(blog!.data.pubDate)

let images

if (blog.data.mainImage) {
  images = import.meta.glob<{ default: ImageMetadata }>(
    '/src/assets/BlogImages/*.{jpeg,jpg,png,gif}',
  )
  if (!images[blog.data.mainImage])
    throw new Error(`"${blog.data.mainImage}" does not exist in BlogImages`)
}
---

<a href=`/blog/${blog?.slug}`>
  <div
    class="flex flex-row w-full p-8 lg:pl-16 lg:pr-16 items-center rounded-lg bg-bg hover:bg-light enlarge-102"
  >
    <div class="flex flex-col gap-3 w-2/3 justify-start">
      <div>
        <h1 class="text-4xl">{formattedTitle}</h1>
        <p class="italic text-md">by {blog.data.author}</p>
      </div>
      <p class="text-lg">{blog.data.description}</p>
      <p class="text-muted">{formattedDate}</p>
      <div class="flex flex-row gap-2">
        {
          blog.data.tags.sort().map((tag) => (
            <div class="p-2 rounded-sm text-sm bg-dark text-muted">
              <p>#{tag}</p>
            </div>
          ))
        }
      </div>
    </div>
    <div class="flex ml-4 w-1/3 justify-end">
      {
        blog.data.mainImage && images && (
          <Image src={images[blog.data.mainImage]()} alt={blog.data.title} />
        )
      }
    </div>
  </div>
</a>
